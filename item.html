<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Details - TrackNova</title>
  <!-- Tailwind for dev only -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">

<div class="w-full max-w-2xl bg-white p-6 rounded-2xl shadow-lg">

  <!-- Login Section -->
  <div id="loginSection" class="space-y-3">
    <h1 class="text-2xl font-bold mb-2 text-center">User Login</h1>
    <input id="email" type="email" placeholder="Email" class="w-full p-2 border rounded-lg"/>
    <input id="password" type="password" placeholder="Password" class="w-full p-2 border rounded-lg"/>
    <button id="loginBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">Login</button>
    <p id="loginStatus" class="text-red-500 text-center hidden"></p>
  </div>

  <!-- Task Section (hidden until login) -->
  <div id="taskSection" class="hidden mt-6">
    <h1 class="text-2xl font-bold mb-4">Task Details</h1>

    <div id="taskDetails" class="space-y-2 p-4 border rounded-lg bg-gray-50">
      <p><strong>Title:</strong> <span id="taskTitle"></span></p>
      <p><strong>Assigned Person:</strong> <span id="taskPerson"></span></p>
      <p><strong>Lab Number:</strong> <span id="taskLab"></span></p>
      <p><strong>Status:</strong> <span id="taskStatus"></span></p>
      <p><strong>Notes:</strong> <span id="taskNotes"></span></p>
      <p><strong>Created:</strong> <span id="taskCreated"></span></p>
    </div>

    <div class="mt-6">
      <h2 class="text-xl font-semibold mb-2">Send Notification to Admin</h2>
      <textarea id="notificationMessage" class="w-full border rounded-lg p-2" rows="3" placeholder="Write your message..."></textarea>
      <button id="sendNotification" class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">Send Notification</button>
      <p id="statusMessage" class="mt-2 text-green-600 font-medium hidden">✅ Notification sent successfully!</p>

      <div class="mt-4">
        <h3 class="text-lg font-semibold mb-2">Your Past Notifications</h3>
        <ul id="pastNotifications" class="space-y-2 max-h-40 overflow-y-auto border p-2 rounded-lg bg-gray-50">
          <li class="text-gray-500">Loading notifications...</li>
        </ul>
      </div>
    </div>
  </div>

</div>

<script>
window.addEventListener("DOMContentLoaded", () => {

  // ---------------- Supabase Setup ----------------
  const SUPABASE_URL = "https://jkynrslsfqwhsvrgzmle.supabase.co"; 
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpreW5yc2xzZnF3aHN2cmd6bWxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzMyNDQsImV4cCI6MjA3MzQwOTI0NH0.HEuMyMWchJYIKH3XGhXavpfmDrdiQeChMyk1WG13C8g"; 
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ---------------- DOM Elements ----------------
  const loginSection = document.getElementById("loginSection");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  const loginStatus = document.getElementById("loginStatus");

  const taskSection = document.getElementById("taskSection");
  const taskTitle = document.getElementById("taskTitle");
  const taskPerson = document.getElementById("taskPerson");
  const taskLab = document.getElementById("taskLab");
  const taskStatus = document.getElementById("taskStatus");
  const taskNotes = document.getElementById("taskNotes");
  const taskCreated = document.getElementById("taskCreated");

  const notificationMessage = document.getElementById("notificationMessage");
  const sendNotification = document.getElementById("sendNotification");
  const statusMessage = document.getElementById("statusMessage");
  const pastNotifications = document.getElementById("pastNotifications");

  // ✅ Get Task ID from QR URL
  const urlParams = new URLSearchParams(window.location.search);
  const taskId = urlParams.get("id");   // <-- updated to "id"

  // ---------------- Login Function ----------------
  loginBtn.addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) return alert("Enter email & password");

    try {
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        console.error("Login error:", error);
        loginStatus.textContent = error.message;
        loginStatus.classList.remove("hidden");
        return;
      }

      console.log("Login successful:", data);

      // Show task section
      loginSection.classList.add("hidden");
      taskSection.classList.remove("hidden");

      fetchTask();
      fetchNotifications();

    } catch (err) {
      console.error("Unexpected error:", err);
      loginStatus.textContent = "Unexpected error occurred.";
      loginStatus.classList.remove("hidden");
    }
  });

  // ---------------- Fetch Task ----------------
  async function fetchTask() {
    if (!taskId) {
      alert("No task ID provided in QR code URL!");
      return;
    }

    const { data, error } = await supabaseClient.from("tasks").select("*").eq("task_id", taskId).single();
    if (error) {
      alert("Error fetching task");
      console.error(error);
      return;
    }
    taskTitle.textContent = data.title;
    taskPerson.textContent = data.assigned_person;
    taskLab.textContent = data.lab_number;
    taskStatus.textContent = data.status;
    taskNotes.textContent = data.notes || "No notes";
    taskCreated.textContent = new Date(data.created_at).toLocaleString();
  }

  // ---------------- Fetch Notifications ----------------
  async function fetchNotifications() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    const { data, error } = await supabaseClient
      .from("notifications")
      .select("*")
      .eq("task_id", taskId)
      .eq("user_id", user.id)
      .order("created_at", { ascending: false });

    pastNotifications.innerHTML = "";

    if (error) {
      pastNotifications.innerHTML = `<li class="text-red-500">Error loading notifications</li>`;
      return;
    }

    if (!data || data.length === 0) {
      pastNotifications.innerHTML = `<li class="text-gray-500">No notifications sent yet</li>`;
      return;
    }

    data.forEach(notif => {
      const li = document.createElement("li");
      li.className = "bg-blue-100 text-blue-800 p-2 rounded shadow-sm";
      li.textContent = `${new Date(notif.created_at).toLocaleString()} - ${notif.message}`;
      pastNotifications.appendChild(li);
    });
  }

  // ---------------- Send Notification ----------------
  sendNotification.addEventListener("click", async () => {
    const message = notificationMessage.value.trim();
    if (!message) return alert("Enter a message");

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return alert("Must be logged in");

    const { error } = await supabaseClient
      .from("notifications")
      .insert([{ task_id: taskId, user_id: user.id, message, is_read: false }]);

    if (error) {
      alert("Error sending notification");
      console.error(error);
      return;
    }

    notificationMessage.value = "";
    statusMessage.classList.remove("hidden");
    setTimeout(() => statusMessage.classList.add("hidden"), 3000);
    fetchNotifications();
  });

});
</script>
</body>
</html>
